{% extends 'accommodation/base.html' %}
{% load static %}

{% block title %}UniHaven - Add New Accommodation{% endblock %}
{% block nav_title %}Add New Accommodation{% endblock %}

{% block extra_css %}
<style>
    .api-key-warning {
        background-color: #fff3cd;
        color: #856404;
        padding: 10px 15px;
        border-radius: 4px;
        margin-bottom: 20px;
        display: none;
    }
    
    .api-key-warning a {
        color: #533f03;
        text-decoration: underline;
        font-weight: bold;
    }
    
    .unique-identifier-info {
        background-color: #e8f4fd;
        border-left: 4px solid #17a2b8;
        padding: 10px 15px;
        margin: 10px 0 20px 0;
        font-size: 0.9em;
    }

    /* 添加样式以支持同一行的多个字段 */
    .form-row {
        display: flex;
        gap: 20px;
        margin-bottom: 15px;
    }
    
    .form-row .form-group {
        flex: 1;
        margin-bottom: 0;
    }
    
    .form-group small {
        display: block;
        margin-top: 5px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <!-- API密钥警告 -->
    <div id="apiKeyWarning" class="api-key-warning">
        <strong>Attention!</strong> The API key was not detected. Adding accommodation requires a valid API key for authentication.
        <a href="{% url 'api_key_management' %}">Click here to set your API key</a>
    </div>
    
    <div class="form-card">
        <form method="post" id="accommodationForm">
            {% csrf_token %}
            <div class="form-grid">
                <div class="section-title">Basic Information</div>
                
                <div class="form-group">
                    <label for="id_title">Title: <span class="required">*</span></label>
                    <input type="text" name="title" id="id_title" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label for="id_type">Accommodation Type: <span class="required">*</span></label>
                    <select name="type" id="id_type" class="form-control" required>
                        <option value="">-- Select Type --</option>
                        <option value="APARTMENT">Apartment</option>
                        <option value="HOUSE">House</option>
                        <option value="HOSTEL">Hostel</option>
                    </select>
                </div>
                
                <div class="form-group full-width">
                    <label for="id_description">Description: <span class="required">*</span></label>
                    <textarea name="description" id="id_description" class="form-control" rows="4" required></textarea>
                </div>
                
                <div class="section-title">Property Details</div>
                
                <div class="form-group">
                    <label for="id_beds">Number of Beds: <span class="required">*</span></label>
                    <input type="number" name="beds" id="id_beds" class="form-control" min="1" required>
                </div>
                
                <div class="form-group">
                    <label for="id_bedrooms">Number of Bedrooms: <span class="required">*</span></label>
                    <input type="number" name="bedrooms" id="id_bedrooms" class="form-control" min="1" required>
                </div>
                
                <!-- 将Price和Address放在同一行 -->
                <div class="form-row full-width">
                    <div class="form-group">
                        <label for="id_price">Price (HKD): <span class="required">*</span></label>
                        <input type="number" name="price" id="id_price" class="form-control" step="0.01" min="0" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="id_address">Address: <span class="required">*</span></label>
                        <input type="text" name="address" id="id_address" class="form-control" required
                               placeholder="Enter the building name">
                        <small class="form-text text-muted">The address will be geocoded using the Hong Kong government API.</small>
                    </div>
                </div>
                
                <div class="unique-identifier-info">
                    <p><strong>Unit Identification</strong> - These fields help uniquely identify the specific unit:</p>
                </div>
                
                <div class="form-group">
                    <label for="id_floor_number">Floor Number:</label>
                    <input type="text" name="floor_number" id="id_floor_number" class="form-control">
                </div>
                
                <div class="form-group">
                    <label for="id_flat_number">Flat/Unit Number:</label>
                    <input type="text" name="flat_number" id="id_flat_number" class="form-control">
                </div>
                
                <div class="form-group">
                    <label for="id_room_number">Room Number:</label>
                    <input type="text" name="room_number" id="id_room_number" class="form-control">
                </div>
                
                <div class="section-title">Availability</div>
                
                <div class="form-group">
                    <label for="id_available_from">Available From: <span class="required">*</span></label>
                    <input type="date" name="available_from" id="id_available_from" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label for="id_available_to">Available To: <span class="required">*</span></label>
                    <input type="date" name="available_to" id="id_available_to" class="form-control" required>
                </div>
                
                <div class="section-title">Contact Information</div>
                
                <div class="form-group">
                    <label for="id_contact_phone">Contact Phone:</label>
                    <input type="tel" name="contact_phone" id="id_contact_phone" class="form-control">
                </div>
                
                <div class="form-group">
                    <label for="id_contact_email">Contact Email:</label>
                    <input type="email" name="contact_email" id="id_contact_email" class="form-control">
                </div>
                
                <div class="submit-row">
                    <button type="submit" class="btn btn-primary btn-full">Add Accommodation</button>
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 日期范围验证
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        const todayFormatted = `${yyyy}-${mm}-${dd}`;
        
        const fromDateInput = document.getElementById('id_available_from');
        fromDateInput.min = todayFormatted;
        
        const toDateInput = document.getElementById('id_available_to');
        toDateInput.min = todayFormatted;
        
        fromDateInput.addEventListener('change', function() {
            if (fromDateInput.value) {
                toDateInput.min = fromDateInput.value;
                
                if (toDateInput.value && toDateInput.value < fromDateInput.value) {
                    toDateInput.value = fromDateInput.value;
                }
            }
        });
        
        toDateInput.addEventListener('change', function() {
            if (toDateInput.value && fromDateInput.value && fromDateInput.value > toDateInput.value) {
                alert('The end date must be after the start date.');
                toDateInput.value = fromDateInput.value;
            }
        });
        
        // API密钥检查和表单提交修改
        const apiKeyWarning = document.getElementById('apiKeyWarning');
        const form = document.getElementById('accommodationForm');
        
        // 检查是否有API密钥
        const apiKey = localStorage.getItem('unihaven_api_key');
        if (!apiKey) {
            apiKeyWarning.style.display = 'block';
        }
        
        // 拦截表单提交
        form.addEventListener('submit', function(event) {
            event.preventDefault();
            
            // 如果没有API密钥，显示警告
            if (!apiKey) {
                alert('A valid API key is required to add accommodations! Please set your key on the API Key Management page.');
                return;
            }
            
            // 创建FormData对象
            const formData = new FormData(form);
            
            // 修正API请求URL，URL应该是/api/add-accommodation/而不是/accommodation/add-accommodation/
            fetch('/api/add-accommodation/', {
                method: 'POST',
                headers: {
                    'X-API-Key': apiKey
                    // 注意：使用FormData时不要手动设置Content-Type，让浏览器自动处理
                },
                body: formData
            })
            .then(response => {
                // 增加错误日志以便调试
                console.log('Response status:', response.status);
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    alert('Accommodation added successfully!');
                    window.location.href = `/api/accommodation_detail/${data.id}/`;
                } else {
                    // 处理错误
                    let errorMessage = data.message || '';
                    if (data.errors) {
                        errorMessage += '\n' + Object.entries(data.errors)
                            .map(([key, value]) => `${key}: ${value.join(', ')}`)
                            .join('\n');
                    }
                    alert(`Failed to add accommodation:\n${errorMessage}`);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while submitting the form');
            });
        });
    });
</script>
{% endblock %}
