{% extends 'accommodation/base.html' %}
{% load static %}

{% block title %}UniHaven - {{ accommodation.title }}{% endblock %}
{% block nav_title %}Accommodation Details{% endblock %}

{% block extra_css %}
<style>
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
    }
    
    .modal-content {
        background-color: white;
        margin: 15% auto;
        padding: 20px;
        width: 80%;
        max-width: 500px;
        border-radius: 5px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .admin-section {
        margin-top: 20px;
        padding-top: 15px;
        border-top: 1px solid #eee;
        display: none;
    }
    
    .delete-btn {
        background-color: #dc3545;
        color: white;
    }
    
    .delete-btn:hover {
        background-color: #bd2130;
    }

    .rating-summary {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
        justify-content: center;
    }
    
    .average-rating {
        text-align: center;
    }
    
    .rating-value {
        font-size: 2em;
        font-weight: bold;
        color: var(--primary-color);
    }
    
    .stars {
        font-size: 1.5em;
        color: #ccc;
        margin: 5px 0;
    }
    
    .star {
        cursor: pointer;
    }
    
    .star.filled {
        color: #ffcc00;
    }
    
    .star.half-filled {
        position: relative;
        display: inline-block;
        color: #ccc;
    }
    
    .star.half-filled:before {
        content: "★";
        position: absolute;
        left: 0;
        top: 0;
        width: 50%;
        overflow: hidden;
        color: #ffcc00;
    }
    
    .rating-count {
        color: #666;
        font-size: 0.9em;
    }

    .status-badge {
        display: inline-block;
        padding: 3px 10px;
        border-radius: 20px;
        font-size: 0.8em;
        font-weight: 500;
    }
    
    .status-badge.status-reserved {
        background-color: #f8d7da;
        color: #721c24;
    }
    
    .status-badge.status-available {
        background-color: #d4edda;
        color: #155724;
    }
    
    .api-status {
        display: flex;
        align-items: center;
        gap: 10px; 
    }
</style>
{% endblock %}

{% block content %}
<div class="detail-container">
    <div class="detail-header">
        <h1>{{ accommodation.title }}</h1>
    </div>
    
    <div class="detail-content">
        <div class="detail-section">
            <h2>Basic Information</h2>
            <div class="detail-item">
                <div class="detail-label">Description:</div>
                <div class="detail-value">{{ accommodation.description }}</div>
            </div>
            <div class="detail-item">
                <div class="detail-label">Type:</div>
                <div class="detail-value">{{ accommodation.type }}</div>
            </div>
            <div class="detail-item">
                <div class="detail-label">Price:</div>
                <div class="detail-value">${{ accommodation.price }}</div>
            </div>
        </div>
        
        <div class="detail-section">
            <h2>Features</h2>
            <div class="detail-item">
                <div class="detail-label">Beds:</div>
                <div class="detail-value">{{ accommodation.beds }}</div>
            </div>
            <div class="detail-item">
                <div class="detail-label">Bedrooms:</div>
                <div class="detail-value">{{ accommodation.bedrooms }}</div>
            </div>
        </div>
        
        <div class="detail-section">
            <h2>Location</h2>
            <div class="detail-item">
                <div class="detail-label">Address:</div>
                <div class="detail-value">{{ accommodation.formatted_address }}</div>
            </div>
            
            {% if accommodation.floor_number or accommodation.flat_number or accommodation.room_number %}
            <div class="detail-item">
                <div class="detail-label">Unit Details:</div>
                <div class="detail-value">
                    {% if accommodation.flat_number %}Flat: {{ accommodation.flat_number }}{% endif %}
                    {% if accommodation.floor_number %}{% if accommodation.flat_number %}, {% endif %}Floor: {{ accommodation.floor_number }}{% endif %}
                    {% if accommodation.room_number %}{% if accommodation.flat_number or accommodation.floor_number %}, {% endif %}Room: {{ accommodation.room_number }}{% endif %}
                </div>
            </div>
            {% endif %}
        </div>
        
        <div class="detail-section">
            <h2>Availability</h2>
            <div class="detail-item">
                <div class="detail-label">Available From:</div>
                <div class="detail-value">{{ accommodation.available_from }}</div>
            </div>
            <div class="detail-item">
                <div class="detail-label">Available To:</div>
                <div class="detail-value">{{ accommodation.available_to }}</div>
            </div>
            
            {% if accommodation.affiliated_universities.exists %}
            <div class="detail-item">
                <div class="detail-label">Affiliated Universities:</div>
                <div class="detail-value">
                    {% for uni in accommodation.affiliated_universities.all %}
                        {{ uni.name }}{% if not forloop.last %}, {% endif %}
                    {% endfor %}
                </div>
            </div>
            <div class="detail-item info-note">
                <p><i>This accommodation is specifically available to students from the above-listed universities.</i></p>
            </div>
            {% endif %}
        </div>

        <div class="detail-section">
            <h2>Ratings and Availability</h2>
            <div style="display: flex; flex-direction: row; align-items: center; justify-content: center; gap: 25px; margin-bottom: 20px;">
                <div class="rating-summary">
                    <div class="average-rating">
                        <span class="rating-value">{{ accommodation.rating }}</span>
                        <div class="stars">
                            {% for i in "12345" %}
                                {% if forloop.counter <= accommodation.rating %}
                                    <span class="star filled">★</span>
                                {% elif forloop.counter <= accommodation.rating|add:0.5 %}
                                    <span class="star half-filled">★</span>
                                {% else %}
                                    <span class="star">☆</span>
                                {% endif %}
                            {% endfor %}
                        </div>
                        <div class="rating-count">{{ accommodation.rating_count }} ratings</div>
                    </div>
                </div>
                
                <span class="status-badge {% if accommodation.reserved %}status-reserved{% else %}status-available{% endif %}">
                    <i class="fas {% if accommodation.reserved %}fa-calendar-times{% else %}fa-calendar-check{% endif %}"></i>
                    {% if accommodation.reserved %}Reserved{% else %}Available{% endif %}
                </span>
            </div>
        </div>
        
        <!-- Student-specific actions section - Will be hidden for specialists -->
        <div id="studentActionsSection" style="display: flex; justify-content: center; margin-top: 15px;">
            <!-- Reserve button -->
            <a href="javascript:void(0);" onclick="showUserIdPrompt('reserve', '{{ accommodation.id }}')" class="btn btn-primary back-button">Reserve</a>
            <!-- Cancel button -->
            <a href="javascript:void(0);" onclick="showUserIdPrompt('cancel', '{{ accommodation.id }}')" class="btn btn-secondary back-button" style="background-color: red;">Cancel</a>
        </div>
        
        <!-- Student navigation buttons -->
        <div id="studentButtonGroup" class="button-group" style="display: flex; gap: 10px; justify-content: center; margin-top: 15px;">
            <!-- Back to Listings button with all original query parameters -->
            <a href="{% url 'list_accommodation' %}?{{ query_string }}" class="btn btn-primary back-button">Back to Listings</a>
            <!-- Back to Search button -->
            <a href="{% url 'search_accommodation' %}" class="btn btn-secondary back-button">Back to Search</a>
        </div>
        
        <!-- Administrator Function Area (API key required) -->
        <div id="adminSection" class="admin-section">
            <h3>Specialist</h3>
            <div style="display: flex; justify-content: center; gap: 10px; margin-top: 10px;">
                <a href="{% url 'add_accommodation' %}" class="btn btn-primary">Add Accommodation</a>
                <button onclick="showDeleteModal()" class="btn btn-primary" style="background-color: #dc3545; border-color: #dc3545;">Delete Accommodation</button>
                <a href="{% url 'manage_accommodations' %}" class="btn btn-secondary">Manage Accommodations</a>
            </div>
        </div>
    </div>
</div>

<!-- Delete the confirmation modal box-->
<div id="deleteModal" class="modal">
    <div class="modal-content">
        <h3 style="text-align: center;">Confirm deletion</h3>
        <p style="text-align: center;">Are you sure you want to delete "{{ accommodation.title }}"？</p>
        <p>This operation is <strong>irreversible</strong>, Data cannot be recovered after deletion.</p>
        <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px;">
            <button onclick="hideDeleteModal()" class="btn btn-secondary">Cancel</button>
            <button onclick="deleteAccommodation('{{ accommodation.id }}')" class="btn btn-danger">Confirm Delete</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Check if there is an API key and display the administrator function
    document.addEventListener('DOMContentLoaded', function() {
        const apiKey = localStorage.getItem('unihaven_api_key');
        if (apiKey) {
            // Show admin section and hide student actions for specialists
            document.getElementById('adminSection').style.display = 'block';
            document.getElementById('studentActionsSection').style.display = 'none';
            
            // Show specialist navigation and hide student navigation
            document.getElementById('studentButtonGroup').style.display = 'none';
        }
    });
    
    function showUserIdPrompt(action, accommodationId) {
        if (action === 'reserve') {
            const urlParams = new URLSearchParams(window.location.search);
            let userId = urlParams.get('user_id');

            let contactNumber = prompt("Please enter your contact phone number:");
            if (!contactNumber) {
                alert("Contact number is required for reservation");
                return;
            }
            
            reserveAccommodation(accommodationId, userId, contactNumber);
        } else if (action === 'cancel') {
            let userId = prompt("Please enter your User ID to cancel the reservation");
            if (!userId) return;
            cancelReservation(accommodationId, userId);
        }
    }
    
    // Reserve accommodation
    async function reserveAccommodation(accommodationId, userId, contactNumber) {
        const csrfToken = getCSRFToken();
        try {
            const response = await fetch(`/api/reserve_accommodation/?id=${accommodationId}&User%20ID=${encodeURIComponent(userId)}&contact_number=${encodeURIComponent(contactNumber)}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                }
            });

            const data = await response.json();
            
            if (response.ok) {
                alert(data.message);
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = "{% url 'view_reservations' %}";
                
                const csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = 'csrfmiddlewaretoken';
                csrfInput.value = csrfToken;
                form.appendChild(csrfInput);
                
                const userIdInput = document.createElement('input');
                userIdInput.type = 'hidden';
                userIdInput.name = 'user_id';
                userIdInput.value = userId;
                form.appendChild(userIdInput);
                
                document.body.appendChild(form);
                form.submit();
            } else {
                alert(`Fail to Reserve: ${data.message}`);
            }
        } catch (error) {
            console.error('Error reserving accommodation:', error);
            alert('An error occurred when booking accommodation.');
        }
    }

    // cancel reservation
    async function cancelReservation(accommodationId, userId) {
        const csrfToken = getCSRFToken();
        try {
            const response = await fetch(`/api/cancel_reservation/?id=${accommodationId}&User%20ID=${encodeURIComponent(userId)}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                }
            });

            const data = await response.json();
            
            if (response.ok) {
                alert(data.message);
                // location.reload();
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = "{% url 'view_reservations' %}";
                
                // 添加CSRF token
                const csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = 'csrfmiddlewaretoken';
                csrfInput.value = csrfToken;
                form.appendChild(csrfInput);
                
                // Pass the user ID to the form
                const userIdInput = document.createElement('input');
                userIdInput.type = 'hidden';
                userIdInput.name = 'user_id';
                userIdInput.value = userId;
                form.appendChild(userIdInput);
                
                // Add to the page and submit
                document.body.appendChild(form);
                form.submit();
            } else {
                alert(`Failed to cancel the reservation: ${data.message}`);
            }
        } catch (error) {
            console.error('Error canceling reservation:', error);
            alert('An error occurred when canceling the reservation.');
        }
    }
    
    // Display the deletion confirmation modal box
    function showDeleteModal() {
        document.getElementById('deleteModal').style.display = 'block';
    }
    
    // Hide the deletion confirmation modal box
    function hideDeleteModal() {
        document.getElementById('deleteModal').style.display = 'none';
    }
    
    // delete accommodation
    async function deleteAccommodation(accommodationId) {
        const apiKey = localStorage.getItem('unihaven_api_key');
        if (!apiKey) {
            alert('A valid API key is required to delete the accommodation！');
            hideDeleteModal();
            return;
        }
        
        try {
            const response = await fetch('/api/delete-accommodation/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-API-Key': apiKey,
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify({
                    id: accommodationId
                })
            });
            
            const data = await response.json();
            
            if (response.ok) {
                alert('The accommodation has been successfully deleted！');
                window.location.href = "{% url 'manage_accommodations' %}";
            } else {
                alert(`Fail to delete: ${data.message}`);
                hideDeleteModal();
            }
        } catch (error) {
            console.error('Error deleting accommodation:', error);
            alert('An error occurred when deleting the accommodation.');
            hideDeleteModal();
        }
    }

    // get CSRF token from cookies
    function getCSRFToken() {
        return getCookie('csrftoken');
    }

    // get cookie
    function getCookie(name) {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.startsWith(name + '=')) {
                return cookie.substring(name.length + 1);
            }
        }
        return null;
    }

    document.addEventListener('DOMContentLoaded', function () {
        const userIdentifier = getCookie('user_identifier');
        if (!userIdentifier) {
            // Generate a unique identifier for the user (e.g., a random string or UUID)
            const uniqueId = 'user_' + Math.random().toString(36).substring(2, 15);
            setCookie('user_identifier', uniqueId, 365); // Set cookie to expire in 1 year
            console.log('User identifier cookie set:', uniqueId);
        } else {
            console.log('User identifier cookie already exists:', userIdentifier);
        }
    });
</script>
{% endblock %}
